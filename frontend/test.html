<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Flask Socket.IO JWT Test</title>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>

        <style>
            body {
                font-family: monospace;
                background: #111;
                color: #eee;
            }
            button {
                margin: 4px;
            }
            #log {
                white-space: pre-wrap;
                border: 1px solid #444;
                padding: 10px;
                height: 300px;
                overflow-y: auto;
            }
        </style>
    </head>

    <body>
        <h2>Flask + Socket.IO (JWT)</h2>

        <label>Username: <input id="username" value="testuser" /></label><br />
        <label
            >Password:
            <input id="password" type="password" value="testpass" /></label
        ><br /><br />

        <button onclick="signup()">Signup</button>
        <button onclick="login()">Login</button>
        <button onclick="connectSocket()">Connect Socket</button><br /><br />

        <label>Message: <input id="message" value="Hello world" /></label>
        <button onclick="sendMessage()">Send</button>

        <h3>Log</h3>
        <div id="log"></div>

        <script>
            let socket = null;
            let accessToken = null;

            function log(msg) {
                const el = document.getElementById("log");
                el.textContent += msg + "\n";
                el.scrollTop = el.scrollHeight;
            }

            async function signup() {
                const res = await fetch("http://localhost:5000/signup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value,
                    }),
                });

                log(`Signup status: ${res.status}`);
                log(await res.text());
            }

            async function login() {
                const res = await fetch("http://localhost:5000/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value,
                    }),
                });

                const data = await res.json();
                log(`Login status: ${res.status}`);
                log(JSON.stringify(data, null, 2));

                if (res.ok) {
                    accessToken = data.access_token;
                    log("âœ… Access token stored");
                }
            }

            function connectSocket() {
                if (!accessToken) {
                    log("âŒ Login first (no token)");
                    return;
                }

                log("Connecting socket with JWT...");

                socket = io("http://localhost:5000", {
                    auth: {
                        token: accessToken,
                    },
                });

                socket.on("connect", () => {
                    log("âœ… Socket connected");
                });

                socket.on("disconnect", (reason) => {
                    log(`âŒ Socket disconnected (${reason})`);
                });

                socket.on("connect_error", (err) => {
                    log("âŒ Socket error:");
                    log(err.message || err);
                });

                socket.on("old_messages", (msgs) => {
                    log("ðŸ“œ Message history:");
                    msgs.forEach((m) => {
                        log(`[${m.sender}] ${m.message}`);
                    });
                });

                socket.on("new_message", (msg) => {
                    log(`[${msg.sender}] ${msg.message}`);
                });
            }

            function sendMessage() {
                if (!socket || !socket.connected) {
                    log("âš  Socket not connected");
                    return;
                }

                socket.emit("message", {
                    message: message.value,
                });
            }
        </script>
    </body>
</html>
