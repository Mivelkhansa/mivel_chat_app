<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Chat App Full Test</title>
        <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
        <style>
            body {
                font-family: monospace;
                background: #111;
                color: #eee;
            }
            input,
            button {
                margin: 4px;
            }
            #log {
                white-space: pre-wrap;
                border: 1px solid #444;
                padding: 10px;
                height: 400px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <h2>Chat App Full Test</h2>

        <!-- Auth -->
        <div>
            <input id="username" placeholder="Username" value="testuser" />
            <input
                id="password"
                type="password"
                placeholder="Password"
                value="testpass"
            />
            <button onclick="signup()">Signup</button>
            <button onclick="login()">Login</button>
        </div>

        <!-- Room -->
        <div>
            <input id="new_room_name" placeholder="New Room Name" />
            <button onclick="createRoom()">Create Room</button>
            <input id="room_id" placeholder="Room ID" />
            <button onclick="joinRoom()">Join Room</button>
        </div>

        <!-- Messages -->
        <div>
            <input id="message" placeholder="Message" />
            <button onclick="sendMessage()">Send</button>
        </div>

        <!-- Member management -->
        <div>
            <input id="member_id" placeholder="User ID" />
            <button onclick="addMember()">Add Member</button>
            <button onclick="removeMember()">Remove Member</button>
            <button onclick="listMembers()">List Members</button>
        </div>

        <!-- Transfer ownership -->
        <div>
            <input id="new_owner" placeholder="New Owner ID" />
            <button onclick="transferOwner()">Transfer Owner</button>
        </div>

        <h3>Current Room: <span id="current_room">None</span></h3>
        <h3>Log</h3>
        <div id="log"></div>

        <script>
            let socket = null;
            let accessToken = null;
            let currentRoom = null;

            function log(msg) {
                const el = document.getElementById("log");
                el.textContent += msg + "\n";
                el.scrollTop = el.scrollHeight;
            }

            // ------------------ AUTH ------------------
            async function signup() {
                const res = await fetch("http://localhost:5000/signup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value,
                    }),
                });
                log(`Signup ${res.status}: ${await res.text()}`);
            }

            async function login() {
                const res = await fetch("http://localhost:5000/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value,
                    }),
                });
                const data = await res.json();
                log(`Login ${res.status}: ${JSON.stringify(data)}`);
                if (res.ok) {
                    accessToken = data.access_token;
                    log("‚úÖ Access token stored");
                }
            }

            // ------------------ ROOM ------------------
            async function createRoom() {
                if (!accessToken) return log("‚ùå Login first");
                const room_name =
                    document.getElementById("new_room_name").value ||
                    prompt("Room name?", "Test Room");
                if (!room_name) return;
                const res = await fetch("http://localhost:5000/room", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ token: accessToken, room_name }),
                });
                const data = await res.json();
                log(`Create Room ${res.status}: ${JSON.stringify(data)}`);
                if (res.ok) {
                    currentRoom = data.room_id;
                    document.getElementById("room_id").value = currentRoom;
                    document.getElementById("current_room").textContent =
                        currentRoom;
                }
            }

            function joinRoom() {
                if (!accessToken) return log("‚ùå Login first");
                const roomId = document.getElementById("room_id").value;
                if (!roomId) return log("‚ùå Enter room ID");
                currentRoom = roomId;
                document.getElementById("current_room").textContent =
                    currentRoom;

                socket = io("http://localhost:5000");
                socket.on("connect", () => {
                    log("‚úÖ Socket connected");
                    socket.emit("join_room", {
                        room: roomId,
                        token: accessToken,
                    });
                });
                socket.on("disconnect", (r) =>
                    log(`‚ùå Socket disconnected: ${r}`),
                );
                socket.on("connect_error", (e) =>
                    log("‚ùå Socket error: " + (e.message || e)),
                );
                socket.on("error", (e) =>
                    log("‚ùå Socket error: " + JSON.stringify(e)),
                );

                socket.on("old_messages", (msgs) => {
                    log("üìú Old messages:");
                    msgs.forEach((m) =>
                        log(`[${m.timestamp}] ${m.sender}: ${m.message}`),
                    );
                });
                socket.on("new_message", (msg) =>
                    log(`[${msg.timestamp}] ${msg.sender}: ${msg.message}`),
                );
            }

            // ------------------ MESSAGES ------------------
            function sendMessage() {
                if (!socket || !socket.connected)
                    return log("‚ö† Socket not connected");
                socket.emit("message", { message: message.value });
            }

            // ------------------ MEMBER MANAGEMENT ------------------
            async function addMember() {
                if (!accessToken || !currentRoom)
                    return log("‚ùå Login & join room first");
                const userId = member_id.value;
                if (!userId) return;
                const res = await fetch(
                    `http://localhost:5000/room/${currentRoom}/members/${userId}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token: accessToken }),
                    },
                );
                const data = await res.json();
                log(`Add Member: ${JSON.stringify(data)}`);
            }

            async function removeMember() {
                if (!accessToken || !currentRoom)
                    return log("‚ùå Login & join room first");
                const userId = member_id.value;
                if (!userId) return;
                const res = await fetch(
                    `http://localhost:5000/room/${currentRoom}/members/${userId}`,
                    {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token: accessToken }),
                    },
                );
                const data = await res.json();
                log(`Remove Member: ${JSON.stringify(data)}`);
            }

            async function listMembers() {
                if (!accessToken || !currentRoom)
                    return log("‚ùå Login & join room first");
                const res = await fetch(
                    `http://localhost:5000/room/${currentRoom}/members/${accessToken}`,
                    {
                        method: "GET",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token: accessToken }),
                    },
                );
                const data = await res.json();
                log(`Members in room: ${JSON.stringify(data)}`);
            }

            // ------------------ TRANSFER OWNERSHIP ------------------
            async function transferOwner() {
                if (!accessToken || !currentRoom)
                    return log("‚ùå Login & join room first");
                const newOwnerId = new_owner.value;
                if (!newOwnerId) return;
                const res = await fetch(
                    `http://localhost:5000/room/${currentRoom}/transfer-owner/${newOwnerId}`,
                    {
                        method: "PATCH",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ token: accessToken }),
                    },
                );
                const data = await res.json();
                log(`Transfer Owner: ${JSON.stringify(data)}`);
            }
        </script>
    </body>
</html>
